name: Manual Release

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: "Version name for this release (for example: 2.1.0-beta03.4)"
        required: true
      versionCode:
        description: "Optional explicit version code. If empty and autoIncrementVersionCode is true, the workflow will compute the next version code."
        required: false
      autoIncrementVersionCode:
        description: "If true and versionCode is not provided, compute versionCode as the previous code + 1."
        required: false
        type: boolean
        default: true

jobs:
  publish:
    name: Publish charty artifact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Determine versionCode
        id: version
        run: |
          INPUT_CODE="${{ github.event.inputs.versionCode }}"
          AUTO_INC="${{ github.event.inputs.autoIncrementVersionCode }}"

          if [ -n "$INPUT_CODE" ]; then
            NEXT_CODE="$INPUT_CODE"
          elif [ "$AUTO_INC" = "true" ]; then
            # Read last version code from a file if it exists, otherwise start at 1
            if [ -f .github/version-code.txt ]; then
              LAST_CODE=$(cat .github/version-code.txt)
              NEXT_CODE=$((LAST_CODE + 1))
            else
              NEXT_CODE=1
            fi
          else
            echo "versionCode is required when autoIncrementVersionCode is false" >&2
            exit 1
          fi

          echo "versionCode=$NEXT_CODE" >> $GITHUB_OUTPUT

      - name: Configure environment for charty module
        run: |
          echo "POM_ARTIFACT_ID=charty" >> $GITHUB_ENV
          echo "POM_NAME=charty" >> $GITHUB_ENV
          echo "POM_DESCRIPTION=An Elementary Compose Multiplatform Chart library." >> $GITHUB_ENV
          echo "POM_PACKAGING=aar" >> $GITHUB_ENV
          echo "POM_INCEPTION_YEAR=2025" >> $GITHUB_ENV
          echo "GROUP=com.himanshoe" >> $GITHUB_ENV
          echo "VERSION_NAME=${{ github.event.inputs.versionName }}" >> $GITHUB_ENV
          echo "VERSION_CODE=${{ steps.version.outputs.versionCode }}" >> $GITHUB_ENV
          echo "POM_URL=https://github.com/hi-manshu" >> $GITHUB_ENV
          echo "POM_LICENCE_NAME=The Apache Software License, Version 2.0" >> $GITHUB_ENV
          echo "POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt" >> $GITHUB_ENV
          echo "POM_LICENCE_DIST=repo" >> $GITHUB_ENV
          echo "POM_SCM_URL=https://github.com/hi-manshu" >> $GITHUB_ENV
          echo "POM_DEVELOPER_ID=hi-manshu" >> $GITHUB_ENV
          echo "POM_DEVELOPER_NAME=Himanshu Singh" >> $GITHUB_ENV
          echo "POM_DEVELOPER_URL=https://github.com/hi-manshu" >> $GITHUB_ENV

      - name: Import GPG key
        run: |
          # Decode the base64-encoded GPG key and save to file
          echo "${{ secrets.GPG_KEY_CONTENTS }}" | base64 -d > $HOME/secring.gpg

          # Import the GPG key
          gpg --batch --import $HOME/secring.gpg

          # Export the key in ASCII armored format for in-memory signing
          GPG_KEY_ID="${{ secrets.SIGNING_KEY_ID }}"
          gpg --batch --pinentry-mode loopback --passphrase "${{ secrets.SIGNING_PASSWORD }}" \
            --export-secret-keys --armor "$GPG_KEY_ID" > $HOME/private-key.asc

          # Set the signing key as an environment variable (will be used in next step)
          echo "SIGNING_KEY<<EOF" >> $GITHUB_ENV
          cat $HOME/private-key.asc >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Clean up sensitive files
          rm -f $HOME/secring.gpg $HOME/private-key.asc

      - name: Validate Maven Central credentials
        run: |
          if [ -z "${{ secrets.MAVEN_CENTRAL_USERNAME }}" ]; then
            echo "Error: MAVEN_CENTRAL_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.MAVEN_CENTRAL_PASSWORD }}" ]; then
            echo "Error: MAVEN_CENTRAL_PASSWORD secret is not set"
            exit 1
          fi
          echo "Maven Central credentials are configured"
          echo "Username: ${{ secrets.MAVEN_CENTRAL_USERNAME }}"

      - name: Publish with Gradle (Maven Central / custom repo)
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          ./gradlew :charty:publish \
            -PmavenCentralUsername="${MAVEN_CENTRAL_USERNAME}" \
            -PmavenCentralPassword="${MAVEN_CENTRAL_PASSWORD}" \
            -Psigning.keyId="${SIGNING_KEY_ID}" \
            -Psigning.password="${SIGNING_PASSWORD}" \
            -Psigning.key="${SIGNING_KEY}"

      - name: Persist versionCode for next run
        if: success()
        run: |
          mkdir -p .github
          echo "${{ steps.version.outputs.versionCode }}" > .github/version-code.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/version-code.txt || true
          git commit -m "chore: update version code to ${{ steps.version.outputs.versionCode }}" || true
          git push || true

      - name: Build release summary
        if: success()
        id: summary
        run: |
          VERSION_NAME="${{ github.event.inputs.versionName }}"
          VERSION_CODE="${{ steps.version.outputs.versionCode }}"

          echo "Collecting latest changes..."

          # Get the last 10 commit subjects
          git log -10 --pretty=format:'%s' > .recent_commits.txt

          FEATURES=$(grep -iE 'feat|feature' .recent_commits.txt || true)
          FIXES=$(grep -iE 'fix|bug' .recent_commits.txt || true)
          CHORES=$(grep -iE 'chore|refactor|docs' .recent_commits.txt || true)

          echo "Release Summary:" > release-summary.txt
          echo "Charty v$VERSION_NAME (code: $VERSION_CODE)" >> release-summary.txt
          echo "" >> release-summary.txt
          echo "This release includes:" >> release-summary.txt

          if [ -n "$FEATURES" ]; then
            echo "" >> release-summary.txt
            echo "New features:" >> release-summary.txt
            echo "$FEATURES" | sed 's/^/- /' >> release-summary.txt
          fi

          if [ -n "$FIXES" ]; then
            echo "" >> release-summary.txt
            echo "Bug fixes and improvements:" >> release-summary.txt
            echo "$FIXES" | sed 's/^/- /' >> release-summary.txt
          fi

          if [ -n "$CHORES" ]; then
            echo "" >> release-summary.txt
            echo "Internal changes and maintenance:" >> release-summary.txt
            echo "$CHORES" | sed 's/^/- /' >> release-summary.txt
          fi

          if [ ! -s release-summary.txt ]; then
            echo "This release contains internal updates and maintenance changes." >> release-summary.txt
          fi

          echo "" >> release-summary.txt
          echo "Full recent history:" >> release-summary.txt
          git log -10 --pretty=format:'- %s (%h)' >> release-summary.txt

          cat release-summary.txt

      - name: Create and push Git tag
        if: success()
        run: |
          VERSION_NAME="${{ github.event.inputs.versionName }}"

          TAG_NAME="v$VERSION_NAME"

          echo "Creating tag $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Charty v$VERSION_NAME"
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.versionName }}
          name: Charty v${{ github.event.inputs.versionName }}
          body_path: release-summary.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
