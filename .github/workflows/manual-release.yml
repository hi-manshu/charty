name: Manual Publish to Maven Central

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: 'Version name for this release (e.g., 2.1.0 or 2.1.0-beta01)'
        required: true
        type: string

jobs:
  publish:
    name: Publish to Maven Central
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-cleanup: true

      - name: Validate inputs
        run: |
          VERSION="${{ github.event.inputs.versionName }}"
          if [ -z "$VERSION" ]; then
            echo "âŒ Version name is required"
            exit 1
          fi

          # Validate version format (basic semver check)
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$' > /dev/null; then
            echo "âš ï¸ Warning: Version '$VERSION' doesn't follow semantic versioning format (X.Y.Z or X.Y.Z-qualifier)"
          fi

          echo "âœ… Publishing version: $VERSION"

      - name: Validate Maven Central credentials
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        run: |
          if [ -z "$MAVEN_CENTRAL_USERNAME" ]; then
            echo "âŒ Error: MAVEN_CENTRAL_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "$MAVEN_CENTRAL_PASSWORD" ]; then
            echo "âŒ Error: MAVEN_CENTRAL_PASSWORD secret is not set"
            exit 1
          fi
          echo "âœ… Maven Central credentials are configured"

      - name: Validate signing configuration
        env:
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          if [ -z "$SIGNING_KEY_ID" ]; then
            echo "âŒ Error: SIGNING_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "$SIGNING_PASSWORD" ]; then
            echo "âŒ Error: SIGNING_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "$SIGNING_KEY" ]; then
            echo "âŒ Error: SIGNING_KEY secret is not set"
            exit 1
          fi
          echo "âœ… Signing configuration is valid"

      - name: Publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          VERSION_NAME: ${{ github.event.inputs.versionName }}
        run: |
          echo "ðŸ“¦ Publishing Charty $VERSION_NAME to Maven Central..."
          ./gradlew :charty:publishAndReleaseToMavenCentral \
            --no-configuration-cache \
            --stacktrace

      - name: Create Git tag
        if: success()
        run: |
          VERSION="${{ github.event.inputs.versionName }}"
          TAG="v$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "$TAG" -m "Release version $VERSION"
          git push origin "$TAG"

          echo "âœ… Created and pushed tag: $TAG"

      - name: Generate release notes
        if: success()
        id: release_notes
        run: |
          VERSION="${{ github.event.inputs.versionName }}"

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi

          # Create release notes
          cat > release-notes.md << EOF
          ## Charty v$VERSION

          ### ðŸ“¦ Maven Coordinates
          \`\`\`kotlin
          implementation("com.himanshoe:charty:$VERSION")
          \`\`\`

          ### ðŸ“ Changes
          $COMMITS

          ### ðŸ”— Links
          - [Maven Central Repository](https://central.sonatype.com/artifact/com.himanshoe/charty/$VERSION)
          - [GitHub Repository](https://github.com/hi-manshu/charty)

          ---
          Published on $(date '+%Y-%m-%d %H:%M:%S UTC')
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.versionName }}
          name: Release v${{ github.event.inputs.versionName }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.event.inputs.versionName, '-alpha') || contains(github.event.inputs.versionName, '-beta') || contains(github.event.inputs.versionName, '-rc') }}

      - name: Job Summary
        if: success()
        run: |
          VERSION="${{ github.event.inputs.versionName }}"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… Successfully Published Charty v$VERSION

          ### ðŸ“¦ Maven Central
          The library has been published to Maven Central and will be available shortly at:
          https://central.sonatype.com/artifact/com.himanshoe/charty/$VERSION

          ### ðŸ·ï¸ Git Tag
          Created and pushed tag: \`v$VERSION\`

          ### ðŸ“± Usage
          Add to your project:
          \`\`\`kotlin
          implementation("com.himanshoe:charty:$VERSION")
          \`\`\`

          ### â±ï¸ Availability
          The artifacts will be available on Maven Central within 10-30 minutes.
          EOF

      - name: Failure Summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ Publishing Failed

          The publication process failed. Please check the logs above for details.

          ### Common Issues:
          1. **Credentials**: Verify MAVEN_CENTRAL_USERNAME and MAVEN_CENTRAL_PASSWORD secrets
          2. **Signing**: Check SIGNING_KEY_ID, SIGNING_PASSWORD, and SIGNING_KEY secrets
          3. **Version**: Ensure the version doesn't already exist on Maven Central
          4. **Build**: Check if the project builds successfully locally

          ### Troubleshooting:
          - Run \`./gradlew :charty:publishToMavenLocal\` locally to test the build
          - Verify your credentials at https://central.sonatype.com/
          - Check if GPG key is properly formatted (should be base64 encoded)
          EOF

        run: |
          VERSION_NAME="${{ github.event.inputs.versionName }}"

          TAG_NAME="v$VERSION_NAME"

          echo "Creating tag $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Charty v$VERSION_NAME"
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.versionName }}
          name: Charty v${{ github.event.inputs.versionName }}
          body_path: release-summary.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
